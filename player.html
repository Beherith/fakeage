<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Fakeage Player</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <script src="/src/jquery-1.6.4.js"></script>
        <script src="/src/jquery.mobile-1.1.0.js"></script>
        <link href="/src/css/jquery.structure.css" rel="stylesheet" />
        <link href="/src/css/jquery.theme.css" rel="stylesheet" />
<script charset="utf-8">
//(C) Peter Sarkozy mysterme@gmail.com
//TODO: 
//	-the server IP must be passed!
//	-the forcstart button loses button formatting on hide/show
//	-there is some confusion about what to display on the player side during scoring...
//	-The headings/prompts on some views are inconsistent, and look like trash
//	-Fix unicode support.
var ipValue = "ws://127.0.0.1:8001/"; 
var connection;
var received_msg;
var loginname = "";
var jsonobj;
var lies;
var mylie;
var viewer = false;
var answer = "";
var checkpng = "<img src=\"/src/check.png\">";
var eckspng = "<img src=\"/src/ecks.png\">";
var likepng = "<img src=\"/src/like.png\">";
var cuppng = "<img src=\"/src/cup.png\">";

function latinize(nonlatin){
	//FUCK THIS HORRIBLE MESS! I HATE FUCKING NON-ASCII CHARACTERS!
	var latin_map = {'É':'E','Á':'A','Ű':'U','Ü':'U','Ö':'O','Ő':'O','Ú':'U','Í':'I','Ó':'O','é':'e','á':'a','ű':'u','ü':'u','ö':'o','ő':'o','ú':'u','í':'i','ó':'o'};
	//undefined
	//unicode.normalize(nonlatin);
	console.log(nonlatin);
	//console.log(nonlatin.replace(/[^A-Za-z0-9\[\] ]/g,function(a){return latin_map[a]||a}));
	//return nonlatin.replace(/[^A-Za-z0-9\[\] ]/g,function(a){return latin_map[a]||a}).toUpperCase();
	var out = '';
	for (var i =0;i<nonlatin.length;i++){
		console.log(nonlatin[i],latin_map[nonlatin[i]]);
		out+= latin_map[nonlatin[i]]||nonlatin[i];
	}
	console.log(out);
	return out
}
function init(){
	showonly('logindiv');
	$("#enterliediv").hide();
	$("#selectliediv").hide();
	$("#logindiv").show();
	$("#viewerdiv").hide();
	
	//console.log("Latize test:",latinize("Búzafűlé	\tcsicskalangos CleanUpString tesztelÉs"));
	connection = new WebSocket(ipValue); //handle failure
	connection.onclose = function(evt) { onClose(evt) };
	connection.onerror = function(evt) { onError(evt) };
	connection.onmessage = function (evt) {
		received_msg = evt.data;
		console.log('Received WS message:'+received_msg);
		if (received_msg.startsWith("Echo")) return;
		try{
			jsonobj = JSON.parse(received_msg);
			console.log('JSON object received:'+jsonobj);
			
			var output = document.getElementById("viewerdivbody");
			output.innerHTML = ''; //clear body
			if (jsonobj.state == 'pregame' && viewer){
				document.getElementById("viewerdivhead").innerHTML = "Waiting for players to join";
				for (var player = 0; player<jsonobj.players.length; player ++){
					var pre = document.createElement("p");
					pre.innerHTML = jsonobj.players[player].name;
					output.appendChild(pre);
					console.log(pre.innerHTML);
				}
			}
			if (jsonobj.state == 'lietome'){
				if (viewer){
					document.getElementById("viewerdivhead").innerHTML = jsonobj.question+'<br>Enter your lies<br>';
					for (var player = 0; player<jsonobj.players.length; player ++){
						var pre = document.createElement("p");
						pre.innerHTML = jsonobj.players[player].name;
						if (jsonobj.players[player].lie != null ) pre.innerHTML = pre.innerHTML + checkpng;
						else pre.innerHTML = pre.innerHTML + eckspng;
						output.appendChild(pre);
						console.log(pre.innerHTML);
					}
				}else{ // show player lie to me ui
					showquestion(jsonobj.question);
					
				}
			}
			if (jsonobj.state == 'lieselection' ){
				if (viewer){
					document.getElementById("viewerdivhead").innerHTML = jsonobj.question+'<br>Select the truth<br>';
					for (var player = 0; player<jsonobj.players.length; player ++){
						var pre = document.createElement("p");
						pre.innerHTML = jsonobj.players[player].name;
						if (jsonobj.players[player].choice != null ) pre.innerHTML = pre.innerHTML + checkpng;
						else pre.innerHTML = pre.innerHTML + eckspng;
						output.appendChild(pre);
						console.log(pre.innerHTML);
					}
				}else{ //show lie selector ui
					//show selectliediv
					showonly("#selectliediv");
					output = document.getElementById("selectliediv") ;
					output.innerHTML = '<h1>'+jsonobj.question+'<br>Select the truth</h1>';
					//var questions = ''
					
					// sort lies in alphabetical order to prevent the truth from floating upper-alpha
					lies = [jsonobj.answer];
					for (var player = 0; player<jsonobj.players.length; player ++){
						if (jsonobj.players[player].lie != null ) lies.push(jsonobj.players[player].lie);
						}
					lies.sort();
					for (var l = 0; l<lies.length; l ++){
						$("#selectliediv").append('<a data-role="button" id="selectliebtn" onclick=\'selectlie("'+lies[l] +'")\' data-inline="true">'+lies[l]+ '</a><br>\n').trigger('create');
						continue;
					
						var question = document.createElement("a");
						question.setAttribute("data-role","button");
						question.setAttribute("id","selectliebtn");
						question.setAttribute("data-inline","true");
						question.setAttribute("onclick","selectlie("+jsonobj.players[player].lie+")");
						question.appendChild(document.createTextNode(jsonobj.players[player].lie));
						question.trigger('create');
						//question += '<a data-role="button" id="selectliebtn" onclick="selectlie(this)" data-inline="true">'+jsonobj.players[player].lie + '</a>\n';
						output.appendChild(question);
						//var elem = document.createElement("p");
						//elem.innerHTML = questions;
						//output.appendChild(elem);
						//console.log(questions);
					}
				}
			};
			if (jsonobj.state == 'scoring'){ //scoring is identical in viewer and player
				
				showonly("#viewerdiv");
				document.getElementById("viewerdivhead").innerHTML = "Scoring";
				var pre = document.createElement("h1");
				var currentlie = jsonobj.currentlie;
				var playerswholiedthis = [];
				var playerswhochosethis = [];
				var playerswholikedthis = [];
				
				var pretext = jsonobj.question + "<br><br>";
				
				
				for (var player = 0; player<jsonobj.players.length; player ++){
					if (jsonobj.players[player].lie == currentlie)    playerswholiedthis.push(jsonobj.players[player].name);
					if (jsonobj.players[player].choice == currentlie) playerswhochosethis.push(jsonobj.players[player].name);
					if (jsonobj.players[player].likes == currentlie)  playerswholikedthis.push(jsonobj.players[player].name);
				}
				
				if (jsonobj.currentlie != jsonobj.answer){
					pretext += currentlie + " is a LIE! Submitted by:<br>" + playerswholiedthis.join(", ")+"<br> Players fooled: "+playerswhochosethis.join(", ");
				}else{
					pretext += currentlie + " is the TRUTH! <br>"
					if (playerswhochosethis.length >0) pretext += " Players correct: " + playerswhochosethis.join(", ");
					else pretext += "No players were correct!";
				}
				
				if (playerswholikedthis.length > 0){
					pretext += "<br> Players who like this answer: "+playerswholikedthis.join(", ");
				}
				pre.innerHTML = pretext;
				output.appendChild(pre);
				console.log(pre.innerHTML);
			};
			if (jsonobj.state == "finalscoring"){//scoring is identical in viewer and player
				var pre = document.createElement("h1");
				pre.innerHTML = jsonobj.question + '<br><br> The TRUTH is '+jsonobj.answer;
				console.log(pre.innerHTML);
				output.appendChild(pre);
				
				var pre = document.createElement("p");
				var tabletext = "<table border = 1><thead><tr><th>Player</th><th>Lie</th><th>Score</th><th>Likes</th></tr></thead><tbody class=\"ui-widget-content\">";
				
				for (var player = 0; player<jsonobj.players.length; player ++){
					var p = jsonobj.players[player];
					var l = "";
					if (p.lie !=null) l=p.lie;
					tabletext += "<tr><td>"+p.name+"</td><td>"+l+"</td><td>"+p.score+cuppng+"</td><td>"+p.likecount+likepng+"</td></tr>\n";
				}
				tabletext += "</tbody></table>";
				pre.innerHTML = tabletext;
				console.log(pre.innerHTML);
				output.appendChild(pre);
			}
		}
		catch(e){
			console.log('Failed to parse json object or other error'+e);
			console.log(received_msg);
		}

	}
}
function xmit(mykey,newValue){
	connection.send(mykey+newValue);
}
function onError(evt){
	console.log('error: ' + evt.data + '\n');
	websocket.close();
}
function onClose(evt){
console.log("disconnected\n");
}
function login(){
	loginname = $("#loginname").val();
	connection.send("loginname:"+loginname);
	console.log("Logged in as:" + loginname);
	$("#logindiv").append('<br><a data-role="button" id="forcestart" onclick="forcestart()" data-inline="true">Force start game</a><br>\n').trigger('create');
	$("#loginbtn").hide();
	$("#viewbtn").hide();
	$("#submitdiv").hide();
}
function view(){
	connection.send("view:None");
	console.log("Logged in as:" + loginname);
	$("#logindiv").hide();
	$("#viewerdiv").show();
	$("#submitdiv").hide();
	viewer = true;
}
function forcestart(){
	connection.send("forcestart:"+loginname);
	console.log("forced start:" + loginname);
}
function lie(){
	mylie = $("#mylie").val().toUpperCase();
	if (mylie == jsonobj.answer){
		$("#mylie").val("You got the correct answer, choose a lie!");
	}else{
		connection.send("lie:"+mylie);
		$("#mylie").hide();
		document.getElementById("questionh").innerHTML = "Lie submitted";
	}
}
function selectlie(me){
	if (me == mylie){ // you cant select your own lie!
		$("#selectliediv").append('<h1>You cant select your own lie!</h1>\n').trigger('create');
		return;
	}
	console.log("selectlie",me,mylie);
	connection.send("choice:"+me);
	console.log(this);
	output = document.getElementById("selectliediv") ;
	output.innerHTML = '<h1>Choice submitted.<br><br>Like the answers for:<br><br>'+jsonobj.question+'</h1>';
	// sort lies in alphabetical order to prevent the truth from floating upper-alpha
	lies = [jsonobj.answer];
	for (var player = 0; player<jsonobj.players.length; player ++){
		if (jsonobj.players[player].lie != null ) lies.push(jsonobj.players[player].lie);
		}
	lies.sort();
	for (var l = 0; l<lies.length; l ++){
		$("#selectliediv").append('<a data-role="button" id="likeliebtn" onclick=\'like("'+lies[l] +'")\' data-inline="true">'+lies[l]+ '</a><br>\n').trigger('create');
	}
}
function like(me){
	if (me == mylie){ // you cant select your own lie!
		$("#selectliediv").append('<h1>You cant like your own lie!</h1>\n').trigger('create');
		return;
	}
	console.log("liked:"+me);
	connection.send('like:'+me);
	$("#selectliediv").hide();
}
function submitq(){
	connection.send('submitq:'+$("#submitquestion").val()+":"+$("#submitanswer").val());
	$("#submitdiv").hide();
}
function showonly(divtoshow){
	var divs = ['#enterliediv','#selectliediv','#logindiv','#viewerdiv'];
	for (var d =0; d < divs.length; d++){
		if (divtoshow == divs[d]){
			//$(divs[d]).show();
			$(divs[d]).slideDown("slow");
			}
		else $(divs[d]).slideUp("slow");
	}
}
function showquestion(q){
	console.log("showquestion:"+q);
	showonly("#enterliediv");
	$("#mylie").show();
	$("#mylie").val("Enter your lie");
	document.getElementById("questionh").innerHTML = q;
}

</script>
</head>  
	<body>
		<div data-role="page" id="page1">
		<div id="pageheader" data-role="header">
			<h1>Fakeage</h1>
		</div>
		<div id="logindiv">
			<h1>Enter your name if you wish to play!</h1>
			<div data-role="fieldcontain">
				<label for="loginname">My name is</label>
				<input type="text" id="loginname" value="Dumbfuck" />
				<a data-role="button" id="loginbtn" onclick="login()" data-inline="true">Play!</a>	
			</div>
			<div data-role="fieldcontain">
				<a data-role="button" id="viewbtn" onclick="view()" data-inline="true">View Game</a>	
			</div>
		</div>
		
		<div id="submitdiv">
			<h1>Submit a question:</h1>
			<div data-role="fieldcontain">
				<label for="submitquestion">Question</label>
				<input type="text" id="submitquestion" value="Enter the ___ you would like to submit." />
				<label for="submitanswer">Answer</label>
				<input type="text" id="submitanswer" value="question" />
				<a data-role="button" id="submitbtn" onclick="submitq()" data-inline="true">Submit question</a>	
			</div>
		</div>
		
		<div id="enterliediv">
			<h1 id="questionh">Enter your lie!</h1>
			<div data-role="fieldcontain">
				<input type="text" id="mylie" value="I cant think of anything.." />
				<a data-role="button" id="liebtn" onclick="lie()" data-inline="true">Submit lie</a>	
			</div>
		</div>
		
		<div id="selectliediv">	
			<h1 id = 'selectlieh'>Select the answer which you think is the truth!</h1>
		</div>
		
		<div id="viewerdiv">	
			<h1 id ='viewerdivhead'>View waiting for server..</h1>
			<div id = "viewerdivbody">
				nobody in yet
			</div>
		</div>
		
		<div data-role="footer">
			<h1>Game by Piti mysterme@gmail.com</h1>
		</div>
		
		<script>init()</script>
			</div>
	 </body>
</html>
